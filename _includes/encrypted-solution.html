<div
    id="solution-editor"
    style="height: 100%; width: 100%"
>
    <div style="display: flex; gap: 10px">
        <span style="font-size: 200%">ðŸ”’</span>
        <p>
            <strong style="display: block; font-weight: bold"
                >Hier verbirgt sich die verschlÃ¼sselte LÃ¶sung!</strong
            >
            <span
                >Um diese anzuzeigen, wird ein spezieller Link benÃ¶tigt. Wie du
                diesen erhalten kannst, wurde im Tutorium mitgeteilt.</span
            >
        </p>
    </div>
</div>

<script src="{{ "/assets/lib/monaco/loader.js?v=" | append: site.github.build_revision | relative_url }}"></script>
<script type="module">
    import { decrypt } from '{{ "/assets/js/solution/encryption.js?v=" | append: site.github.build_revision | relative_url }}';
    import { createEditor } from '{{ "/assets/js/solution/editor.js?v=" | append: site.github.build_revision | relative_url }}';

    const $editor = document.getElementById('solution-editor');

    const url = new URL(location.href);
    const key = url.searchParams.get('key');
    const source = url.searchParams.get('source') ?? 'values';

    async function setupEditor({ code, language, annotations }) {
        $editor.style.outline = '1px solid #eaecef';
        $editor.style.minHeight = '30vh';
        $editor.innerHTML = '';

        const [editor, monaco] = await createEditor({
            element: $editor,
            options: { value: code, language, readOnly: true },
            buildRevision: '{{ site.github.build_revision }}',
            librarySource: '{{ "/assets/lib/monaco" | relative_url }}',
        });

        const markers = annotations.map(
            ({
                line: [startLineNumber, endLineNumber],
                column: [startColumn, endColumn],
                comment: message,
            }) => ({
                startLineNumber,
                endLineNumber,
                startColumn,
                endColumn,
                message,
                severity: monaco.MarkerSeverity.Hint,
            })
        );

        monaco.editor.setModelMarkers(
            editor.getModel(),
            'annotations',
            markers
        );
    }

    async function loadSolution(key) {
        const values = await (await fetch(`./${source}.json`)).json();

        const code = await decrypt(key, values.code);
        const annotations = await decrypt(key, values.annotations);

        return {
            ...values,
            code,
            annotations: JSON.parse(annotations),
        };
    }

    if (key) {
        // drop errors silently
        loadSolution(key).then(setupEditor);
    }
</script>
