<div
    id="solution-editor"
    style="height: 100%; width: 100%"
>
    <div style="display: flex; gap: 10px">
        <span style="font-size: 200%;">ðŸ”’</span>
        <p>
            <strong style="display:block; font-weight: bold;">Hier verbirgt sich die verschlÃ¼sselte LÃ¶sung!</strong>
            <span>Um diese anzuzeigen, wird ein spezieller Link benÃ¶tigt. Wie du diesen erhalten kannst, wurde im Tutorium mitgeteilt.</span>
        </p>
    </div>
</div>

<script src="{{ "/assets/lib/monaco/loader.js?v=" | append: site.github.build_revision | relative_url }}"></script>
<script>
    require.config({
        urlArgs: `v={{ site.github.build_revision }}`,
        paths: {
            vs: '{{ "/assets/lib/monaco" | relative_url }}',
        },
    });
</script>

<script type="module">
    import { decrypt } from '{{ "/assets/js/solution.js?v=" | append: site.github.build_revision | relative_url }}';

    const $editor = document.getElementById('solution-editor');

    const url = new URL(location.href);
    const key = url.searchParams.get('key');
    const source = url.searchParams.get('source') ?? 'values';

    // use requirejs for monaco compat
    require(['vs/editor/editor.main'], () => {
        function createEditor({ code, language, annotations }) {
            $editor.style.outline = '1px solid #eaecef';
            $editor.style.minHeight = '30vh';
            $editor.innerHTML = '';

            const editor = monaco.editor.create($editor, {
                language,
                value: code,
                lineNumbers: 'on',
                automaticLayout: true,
                scrollBeyondLastLine: false,
                renderValidationDecorations: 'on',
                theme: 'vs-light',
                readOnly: true,
                readOnlyMessage: { value: 'Cannot edit this file.' },
            });

            const markers = annotations.map(
                ({
                    line: [startLineNumber, endLineNumber],
                    column: [startColumn, endColumn],
                    comment: message,
                }) => ({
                    startLineNumber,
                    endLineNumber,
                    startColumn,
                    endColumn,
                    message,
                    severity: monaco.MarkerSeverity.Hint,
                })
            );

            monaco.editor.setModelMarkers(
                editor.getModel(),
                'annotations',
                markers
            );
        }

        async function loadSolution(key) {
            const values = await (await fetch(`./${source}.json`)).json();

            const code = await decrypt(key, values.code);
            const annotations = await decrypt(key, values.annotations);

            return {
                ...values,
                code,
                annotations: JSON.parse(annotations),
            };
        }

        if (key) {
            // drop errors silently
            loadSolution(key).then(createEditor);
        }
    });
</script>
